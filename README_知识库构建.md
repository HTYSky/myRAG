# 知识库构建工具使用说明

## 概述

增强版的 `0.build_knowledge_base.py` 现在支持稳健地处理大量PDF文件（2000+），具备完整的进度跟踪、错误处理和断点续处理功能。

## 主要功能

### 1. 进度条和时间估算
- 实时显示处理进度
- 根据当前处理速度估算剩余时间
- 显示已处理、失败、剩余文件数量

### 2. 处理状态记录
- **成功处理的文件**: 记录在 `state.processed_files` 中
- **处理失败的文件**: 记录在 `state.failed_files` 中
- **状态持久化**: 每处理10个文件自动保存状态

### 3. 详细日志记录
- 日志文件: `./assets/processing.log`
- 包含处理过程的详细信息
- 记录每个文件的处理状态和错误信息

### 4. 断点续处理
- 状态文件: `./assets/processing_state.pkl`
- 程序中断后重新运行会自动从断点继续
- 无需重新处理已完成的文件

### 5. 智能警告抑制
- 自动抑制PDF处理过程中的无关紧要警告
- 包括PyMuPDF的颜色设置警告和pdfplumber的警告
- 保持终端输出的清洁和可读性

## 文件结构

```
./assets/
├── processing.log          # 处理日志
├── processing_state.pkl    # 处理状态（临时文件）
├── chunks.json            # 文本块数据
├── metadata.json          # 元数据
└── knowledge_base.index   # FAISS索引
```

## 使用方法

### 首次运行
```bash
python 0.build_knowledge_base.py
```

### 中断后继续
如果处理过程中断，直接重新运行相同命令即可：
```bash
python 0.build_knowledge_base.py
```

程序会自动：
1. 加载之前的状态
2. 跳过已处理的文件
3. 从断点继续处理

## 输出示例

```
============================================================
开始构建知识库
============================================================
发现 2000 个PDF文件
处理状态: 已处理 0, 失败 0, 剩余 2000, 总计 2000
开始PDF文档处理阶段...
开始处理 2000 个PDF文件
处理PDF文件: 100%|██████████| 2000/2000 [2:30:45<00:00, 0.22文件/s, 已处理=2000, 失败=5, 剩余=0, 剩余时间=0:00:00]
✓ 成功处理: document1.pdf
✗ 处理失败: corrupted.pdf
...
```

## 错误处理

### 常见错误类型
1. **文件不存在**: 记录为失败，继续处理下一个
2. **文件损坏**: 记录为失败，继续处理下一个
3. **内存不足**: 程序会记录状态后退出，重启后继续
4. **磁盘空间不足**: 程序会记录状态后退出，清理空间后继续

### 错误恢复
- 所有错误都会被记录到日志文件
- 失败的文件会被标记，不会重复处理
- 可以手动检查失败文件并重新处理

## 性能优化

### 批处理
- 每处理10个文件保存一次状态
- 减少I/O操作，提高处理效率

### 内存管理
- 及时释放已处理文件的内存
- 避免内存泄漏

### 进度跟踪
- 实时更新进度条
- 准确估算剩余时间

## 注意事项

1. **确保磁盘空间充足**: 处理大量PDF需要足够的存储空间
2. **定期检查日志**: 关注处理过程中的错误信息
3. **备份重要数据**: 处理前建议备份原始PDF文件
4. **GPU内存**: 确保有足够的GPU内存用于嵌入模型

## 故障排除

### 如果程序卡住
1. 检查日志文件中的错误信息
2. 确认PDF文件是否损坏
3. 检查磁盘空间是否充足

### 如果处理速度过慢
1. 检查PDF文件大小
2. 确认GPU是否正常工作
3. 考虑调整批处理大小

### 如果状态文件损坏
删除 `./assets/processing_state.pkl` 文件，程序会重新开始处理。

## 完成后的清理

处理完成后，程序会自动：
1. 删除临时状态文件
2. 生成最终的知识库文件
3. 输出处理统计信息

最终输出示例：
```
============================================================
知识库构建完成!
总耗时: 2:30:45
处理文件: 1995 成功, 5 失败
生成块数: 45678
索引维度: 1024
数据保存路径: ./assets
============================================================
```
